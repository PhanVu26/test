<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý danh mục 25M - Position Sizing App</title>
<style>
  /* MOBILE-FIRST CSS */
  :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa9bf;--accent:#2dd4bf;--danger:#ff6b6b}
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  body{margin:0;background:linear-gradient(180deg,#071124 0%, #081627 100%);color:#e6eef8;min-height:100vh;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  small{color:var(--muted)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 3px 10px rgba(2,6,23,0.5)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="number"], input[type="text"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:14px}
  button{background:var(--accent);border:none;color:#03202b;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px;background:rgba(255,255,255,0.03)}
  .danger{background:linear-gradient(90deg,#ffb3b3,#ff6b6b);color:#350001}
  .green{background:linear-gradient(90deg,#b6fff0,#2dd4bf);color:#00352b}
  .small{font-size:12px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  /* responsive buttons */
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px;border-radius:8px}
  footer{margin-top:8px;text-align:center;color:var(--muted);font-size:13px}
  @media(min-width:720px){
    body{padding:24px}
    h1{font-size:20px}
    .grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px}
  }
</style>
</head>
<body>
<header>
  <div>
    <h1>Quản lý danh mục & Position Sizing</h1>
    <small class="muted">Dành cho vốn mẫu 25.000.000 ₫ — mobile-friendly</small>
  </div>
  <div class="small muted">Rule mặc định: <span id="riskLabel">1%</span> /lệnh</div>
</header>

<!-- SETTINGS -->
<div class="card">
  <div class="flex-between">
    <div><strong>Thiết lập vốn & rủi ro</strong><div class="muted small">Lưu local trên trình duyệt</div></div>
    <div class="muted small">Even lot = 100 cp (HOSE/HNX)</div>
  </div>
  <div style="margin-top:8px" class="row">
    <div class="col">
      <label>Vốn (VND)</label>
      <input id="capital" type="number" value="25000000" />
    </div>
    <div style="width:120px">
      <label>% rủi ro / lệnh</label>
      <input id="riskPercent" type="number" value="1" step="0.1" min="0.1" max="5" />
    </div>
    <div style="width:110px">
      <label>Even lot</label>
      <input id="evenLot" type="number" value="100" />
    </div>
  </div>
  <div style="margin-top:8px" class="controls">
    <button id="saveSettings">Lưu</button>
    <button id="resetAll" class="btn-ghost">Reset dữ liệu</button>
    <button id="exportAll" class="btn-ghost">Export watchlist & journal</button>
  </div>
</div>

<div class="grid-2">
  <div>
    <!-- POSITION SIZING -->
    <div class="card">
      <strong>Position Sizing Calculator</strong>
      <div class="muted small">Dựa trên account risk & stop-loss bạn nhập</div>
      <div style="margin-top:8px" class="row">
        <div class="col">
          <label>Mã / Tên</label>
          <input id="psSymbol" type="text" value="VCB" />
        </div>
        <div style="width:120px">
          <label>Giá entry (₫)</label>
          <input id="psEntry" type="number" value="61700" />
        </div>
        <div style="width:120px">
          <label>Giá stop (₫)</label>
          <input id="psStop" type="number" value="56800" />
        </div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col">
          <label>Stop % (tự tính nếu để trống)</label>
          <input id="psStopPct" type="number" step="0.1" />
        </div>
        <div style="width:140px">
          <label>Cho phép odd-lot?</label>
          <select id="psOdd">
            <option value="no">Không</option>
            <option value="yes">Có (odd-lot)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px" class="row">
        <button id="calcBtn">Tính kích thước vị thế</button>
        <button id="addWatchBtn" class="btn-ghost">Thêm watchlist</button>
      </div>

      <div id="psResult" style="margin-top:12px" class="muted small"></div>
    </div>

    <!-- WATCHLIST -->
    <div class="card" id="watchlistCard">
      <div class="flex-between">
        <strong>Watchlist</strong>
        <div class="muted small">Tap 1 mã để edit</div>
      </div>
      <div style="margin-top:8px">
        <table id="watchTable">
          <thead>
            <tr><th>Mã</th><th>Giá</th><th>Stop%</th><th>Alloc%</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><input id="newSymbol" placeholder="Mã, ví dụ: E1VFVN30" /></div>
        <div style="width:100px"><input id="newPrice" type="number" placeholder="Giá" /></div>
        <div style="width:90px"><input id="newStopPct" type="number" placeholder="%stop" /></div>
        <div style="width:90px"><input id="newAlloc" type="number" placeholder="%alloc" /></div>
        <div style="width:100px"><button id="addNew">Thêm</button></div>
      </div>
    </div>

    <!-- TRADE JOURNAL -->
    <div class="card">
      <div class="flex-between">
        <strong>Trade Journal</strong>
        <div class="muted small">Ghi lại entry/exit</div>
      </div>
      <div style="margin-top:8px">
        <div class="row">
          <input id="tjSymbol" placeholder="Mã" />
          <input id="tjQty" type="number" placeholder="Số cp" style="width:100px" />
          <input id="tjPrice" type="number" placeholder="Giá" style="width:120px" />
        </div>
        <div style="margin-top:8px" class="row">
          <select id="tjType"><option value="buy">Buy</option><option value="sell">Sell</option></select>
          <input id="tjStop" placeholder="Stop (₫)" />
          <input id="tjTarget" placeholder="Target (₫)" />
        </div>
        <div style="margin-top:8px" class="row">
          <input id="tjNote" placeholder="Ghi chú" />
          <button id="tjAdd">Thêm vào nhật ký</button>
        </div>
        <div style="margin-top:8px">
          <table id="tjTable"><thead><tr><th>Ngày</th><th>Mã</th><th>Qty</th><th>Giá</th><th>Loại</th><th>Ghi chú</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN: Portfolio & Summary -->
  <div>
    <div class="card">
      <strong>Portfolio / Allocation</strong>
      <div class="muted small">Set % phân bổ: Core / Mid / Spec / Cash</div>
      <div style="margin-top:8px" class="row">
        <div style="width:70px"><input id="allocCore" type="number" value="40" /></div>
        <div style="width:70px"><input id="allocMid" type="number" value="30" /></div>
        <div style="width:70px"><input id="allocSpec" type="number" value="20" /></div>
        <div style="width:70px"><input id="allocCash" type="number" value="10" /></div>
      </div>
      <div style="margin-top:8px">
        <button id="applyAlloc">Áp dụng</button>
        <div id="allocSummary" style="margin-top:8px" class="muted small"></div>
      </div>
    </div>

    <div class="card">
      <strong>Quick metrics</strong>
      <div class="muted small" style="margin-top:8px">
        <div>Rủi ro / lệnh = <span id="showRiskMoney">250,000</span> ₫</div>
        <div>Even-lot = <span id="showEven">100</span> cp</div>
        <div id="oddNote" class="muted small" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="card">
      <strong>Hướng dẫn tóm tắt</strong>
      <div class="muted small" style="margin-top:8px">
        • Rule position sizing & 1–2% trade risk (tham khảo phương pháp position sizing).  [oai_citation_attribution:3‡Investopedia](https://www.investopedia.com/articles/trading/09/determine-position-size.asp?utm_source=chatgpt.com) <br>
        • Even lot = 100 cp cho matching orders, odd-lot có thể dùng nhưng thanh khoản khác.  [oai_citation_attribution:4‡Trung tâm hỗ trợ - TCBS](https://help.tcbs.com.vn/en/trading-regulations-at-hsx-ho-chi-minh-stock-exchange/?utm_source=chatgpt.com) <br>
        • Lưu ý tính phí môi giới & phí chuyển nhượng khi bán (ảnh hưởng lợi nhuận) — kiểm broker.  [oai_citation_attribution:5‡VNDIRECT](https://www.vndirect.com.vn/en/service-fee-schedule/?utm_source=chatgpt.com)
      </div>
    </div>
  </div>
</div>

<footer class="muted small">Mã nguồn: lưu file `index.html`. Dữ liệu lưu local trên thiết bị bạn. Không gửi dữ liệu ra server.</footer>

<script>
/*
  Simple mobile-first portfolio & position-sizing app.
  Persistence via localStorage.
  Features: calc size, watchlist CRUD, allocation, trade journal, export.
*/

// ---------- Utilities ----------
const $ = id=>document.getElementById(id);
const fmtVnd = n => Number(n).toLocaleString('vi-VN');

// Load defaults
let state = {
  capital: 25000000,
  riskPercent: 1,
  evenLot: 100,
  watchlist: [
    {symbol:'E1VFVN30', price:32880, stopPct:8, alloc:40},
    {symbol:'VCB', price:61700, stopPct:8, alloc:10},
    {symbol:'FPT', price:93400, stopPct:12, alloc:10},
    {symbol:'MWG', price:77100, stopPct:12, alloc:10},
    {symbol:'HPG', price:27650, stopPct:15, alloc:10}
  ],
  journal: []
};

// localStorage keys
const LSKEY = 'ps_app_v1';
function loadState(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw) {
      const s = JSON.parse(raw);
      state = Object.assign(state, s);
    }
  }catch(e){console.error('load',e)}
}
function saveState(){
  localStorage.setItem(LSKEY, JSON.stringify(state));
}

// init form values
function bindSettings(){
  $('capital').value = state.capital;
  $('riskPercent').value = state.riskPercent;
  $('evenLot').value = state.evenLot;
  $('riskLabel').textContent = state.riskPercent + '%';
  $('showRiskMoney').textContent = fmtVnd(calcRiskMoney());
  $('showEven').textContent = state.evenLot;
  $('oddNote').textContent = 'Odd-lot có thể dùng nhưng thanh khoản & giá khớp khác (HOSE even-lot = 100).';
}

// calculate risk money per trade
function calcRiskMoney(){
  return Math.round(state.capital * (Number(state.riskPercent)/100));
}

// render watchlist
function renderWatchlist(){
  const tbody = document.querySelector('#watchTable tbody');
  tbody.innerHTML='';
  state.watchlist.forEach((w, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${w.symbol}</strong></td>
      <td>${fmtVnd(w.price)}</td>
      <td>${w.stopPct ?? ''}%</td>
      <td>${w.alloc ?? ''}%</td>
      <td style="text-align:right">
        <button data-idx="${idx}" class="btn-ghost edit">Sửa</button>
        <button data-idx="${idx}" class="btn-ghost del">Xóa</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // attach events
  document.querySelectorAll('.edit').forEach(btn=>{
    btn.onclick = e=>{
      const i = e.target.dataset.idx;
      const w = state.watchlist[i];
      $('newSymbol').value = w.symbol;
      $('newPrice').value = w.price;
      $('newStopPct').value = w.stopPct;
      $('newAlloc').value = w.alloc;
      // remove old on save
      state.watchlist.splice(i,1);
      saveState(); renderWatchlist();
    }
  });
  document.querySelectorAll('.del').forEach(btn=>{
    btn.onclick = e=>{
      if(!confirm('Xóa mã khỏi watchlist?')) return;
      const i = e.target.dataset.idx;
      state.watchlist.splice(i,1);
      saveState(); renderWatchlist();
    }
  });
}

// render journal
function renderJournal(){
  const tbody = document.querySelector('#tjTable tbody');
  tbody.innerHTML = '';
  state.journal.slice().reverse().forEach(j=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(j.date).toLocaleString()}</td><td>${j.symbol}</td><td>${j.qty}</td><td>${fmtVnd(j.price)}</td><td>${j.type}</td><td>${(j.note||'')}</td>`;
    tbody.appendChild(tr);
  });
}

// ---------- Events ----------
document.getElementById('saveSettings').onclick = ()=>{
  state.capital = Number($('capital').value) || state.capital;
  state.riskPercent = Number($('riskPercent').value) || state.riskPercent;
  state.evenLot = Number($('evenLot').value) || state.evenLot;
  $('riskLabel').textContent = state.riskPercent + '%';
  $('showRiskMoney').textContent = fmtVnd(calcRiskMoney());
  $('showEven').textContent = state.evenLot;
  saveState();
  alert('Đã lưu setting vào trình duyệt (localStorage).');
};

document.getElementById('resetAll').onclick = ()=>{
  if(confirm('Reset toàn bộ dữ liệu local?')) {
    localStorage.removeItem(LSKEY);
    location.reload();
  }
};

document.getElementById('exportAll').onclick = ()=>{
  // export watchlist + journal as JSON
  const blob = new Blob([JSON.stringify({watchlist:state.watchlist,journal:state.journal},null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ps_backup.json';
  document.body.appendChild(a); a.click(); a.remove();
};

document.getElementById('addNew').onclick = ()=>{
  const sym = $('newSymbol').value.trim().toUpperCase();
  const price = Number($('newPrice').value) || 0;
  const stopPct = Number($('newStopPct').value) || 10;
  const alloc = Number($('newAlloc').value) || 0;
  if(!sym) return alert('Nhập mã');
  state.watchlist.push({symbol:sym, price:price, stopPct:stopPct, alloc:alloc});
  saveState(); renderWatchlist();
  $('newSymbol').value=''; $('newPrice').value=''; $('newStopPct').value=''; $('newAlloc').value='';
};

document.getElementById('addWatchBtn').onclick = ()=>{
  const sym = $('psSymbol').value.trim().toUpperCase();
  const price = Number($('psEntry').value) || 0;
  const stopPct = Number($('psStopPct').value) || Math.round((1 - (Number($('psStop').value) / price || 0))*100);
  const alloc = 0;
  if(!sym) return alert('Nhập mã');
  state.watchlist.push({symbol:sym, price:price, stopPct:stopPct, alloc:alloc});
  saveState(); renderWatchlist();
  alert('Đã thêm watchlist: ' + sym);
};

// calc position sizing
document.getElementById('calcBtn').onclick = ()=>{
  // read values
  state.capital = Number($('capital').value) || state.capital;
  state.riskPercent = Number($('riskPercent').value) || state.riskPercent;
  state.evenLot = Number($('evenLot').value) || state.evenLot;
  const entry = Number($('psEntry').value);
  let stop = Number($('psStop').value);
  const stopPctInput = $('psStopPct').value;
  const allowOdd = $('psOdd').value === 'yes';
  if(!entry || ( !stop && !stopPctInput)) return alert('Nhập entry và stop (hoặc stop%)');
  let stopPct = stopPctInput ? Number(stopPctInput) : Math.round((1 - (stop/entry))*100);
  if(!stop) stop = Math.round(entry * (1 - stopPct/100));
  const riskMoney = calcRiskMoney(); // money allowed to lose per trade
  const riskPerShare = Math.abs(entry - stop);
  if(riskPerShare <= 0) return alert('Stop price phải khác entry và tạo rủi ro > 0');
  // raw qty
  const qtyRaw = Math.floor(riskMoney / riskPerShare);
  // enforce even-lot unless odd allowed
  const even = Number(state.evenLot) || 100;
  let qtyEven = Math.floor(qtyRaw / even) * even;
  let qtySuggested = qtyEven;
  if(allowOdd && qtyRaw > 0) qtySuggested = qtyRaw; // allow odd
  // cost
  const cost = qtySuggested * entry;
  // R:R hints
  const rr = (entry - stop) > 0 ? ((entry*1.15 - entry)/(entry - stop)) : 'N/A';
  const out = `
    Rủi ro cho phép (1 lệnh) = <strong>${fmtVnd(riskMoney)} ₫</strong><br/>
    Risk/share (entry-stop) = <strong>${fmtVnd(riskPerShare)} ₫</strong><br/>
    Số cp tối đa theo rule = <strong>${qtyRaw}</strong> cp <br/>
    Gợi ý mua (even-lot ${even}): <strong>${qtySuggested}</strong> cp (tổng tiền ~ ${fmtVnd(cost)} ₫)<br/>
    (Nếu qty = 0 => nghĩa là stop quá rộng hoặc vốn nhỏ so với giá/stop đã chọn)<br/>
    Stop ở: <strong>${fmtVnd(stop)} ₫</strong> (${stopPct}% )<br/>
    Nếu muốn mua theo allocation, hãy dùng phần Allocation bên phải để phân bổ tiền.<br/>
  `;
  $('psResult').innerHTML = out;
};

// allocation apply
$('applyAlloc').onclick = ()=>{
  const core = Number($('allocCore').value)||0;
  const mid = Number($('allocMid').value)||0;
  const spec = Number($('allocSpec').value)||0;
  const cash = Number($('allocCash').value)||0;
  const total = core+mid+spec+cash;
  if(total !== 100){ return alert('Tổng % phân bổ phải = 100'); }
  // calculate VND per bucket
  const cap = Number($('capital').value) || state.capital;
  const summary = {
    Core: Math.round(cap * core/100),
    Mid: Math.round(cap * mid/100),
    Spec: Math.round(cap * spec/100),
    Cash: Math.round(cap * cash/100)
  };
  $('allocSummary').innerHTML = `
    Core: <strong>${fmtVnd(summary.Core)} ₫</strong><br/>
    Mid: <strong>${fmtVnd(summary.Mid)} ₫</strong><br/>
    Spec: <strong>${fmtVnd(summary.Spec)} ₫</strong><br/>
    Cash: <strong>${fmtVnd(summary.Cash)} ₫</strong>
  `;
  // store
  state.alloc = {core,mid,spec,cash};
  saveState();
};

// trade journal add
$('tjAdd').onclick = ()=>{
  const s = $('tjSymbol').value.trim().toUpperCase();
  const qty = Number($('tjQty').value) || 0;
  const price = Number($('tjPrice').value) || 0;
  const type = $('tjType').value;
  const note = $('tjNote').value;
  if(!s || !qty || !price) return alert('Nhập mã, qty, price');
  state.journal.push({date:Date.now(), symbol:s, qty, price, type, note});
  saveState(); renderJournal();
  // clear
  $('tjSymbol').value=''; $('tjQty').value=''; $('tjPrice').value=''; $('tjNote').value='';
};

// export csv for journal
function exportCSV(){
  // combine watchlist & journal
  const rows = ['type,field1,field2,field3,field4,field5'];
  rows.push('watchlist, symbol,price,stopPct,alloc,');
  state.watchlist.forEach(w=> rows.push(['watchlist', w.symbol, w.price, w.stopPct, w.alloc, ''].join(',')));
  rows.push('journal,date,symbol,qty,price,type,note');
  state.journal.forEach(j=> rows.push(['journal', new Date(j.date).toLocaleString(), j.symbol, j.qty, j.price, j.type, `"${(j.note||'')}"`].join(',')));
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ps_export.csv'; document.body.appendChild(a); a.click(); a.remove();
}
$('exportAll').addEventListener('click', exportCSV);

// initial load
loadState();
bindSettings();
renderWatchlist();
renderJournal();

// keep save on unload
window.addEventListener('beforeunload', saveState);

</script>
</body>
</html>